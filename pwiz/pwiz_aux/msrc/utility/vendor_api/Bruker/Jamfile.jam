#
# $Id$
#
#
# Original author: Matt Chambers <matt.chambers .@. vanderbilt.edu>
#
# Copyright 2009 Vanderbilt University - Nashville, TN 37232
#
# Licensed under the Apache License, Version 2.0 (the "License"); 
# you may not use this file except in compliance with the License. 
# You may obtain a copy of the License at 
# 
# http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software 
# distributed under the License is distributed on an "AS IS" BASIS, 
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. 
# See the License for the specific language governing permissions and 
# limitations under the License.
# 


import modules ;
import path ;


path-constant API_PATH : . ;


# don't bother defining this API for non-Windows platforms.
if [ modules.peek : NT ]
{

rule vendor-api-requirements ( properties * )
{
    local result ;
    if <toolset>msvc in $(properties)
    {
        result += <assembly>$(API_PATH)/Interop.EDAL.dll ;
        result += <assembly>$(API_PATH)/BDal.CXt.Lc.dll ;
        result += <assembly>$(API_PATH)/BDal.CXt.Lc.Factory.dll ;
        result += <assembly>$(API_PATH)/BDal.CXt.Lc.Interfaces.dll ;
        result += <assembly>$(API_PATH)/BDal.CXt.Lc.UntU2.dll ;
        result += <assembly-dependency>$(API_PATH)/CompassXtractMS.dll ;
        result += <assembly-dependency>$(API_PATH)/boost_regex-vc80-mt-1_33_1-BDAL_20070424.dll ;
        result += <assembly-dependency>$(API_PATH)/boost_thread-vc80-mt-1_33_1-BDAL_20070424.dll ;
        result += <assembly-dependency>$(API_PATH)/libfftw3-3.dll ;
        result += <assembly-dependency>$(API_PATH)/libfftw3f-3.dll ;
        result += <assembly-dependency>$(API_PATH)/NTB-vc80-mt-4_3_61.dll ;
        result += <manifest-dependency>$(API_PATH)/Interop.EDAL.dll ;
        result += <assembly-dependency>$(API_PATH)/Interop.EDAL.SxS.manifest ;
    }
    return $(result) ;
}

lib pwiz_vendor_api_bruker
    : # sources
        CompassData.cpp
    : # requirements

        # - when boost::thread is link=static, the exe header is tweaked to call
        #   thread-local storage initialization routines (before main())
        # - when a /clr object is link=static, the exe header is similarly tweaked
        #   to initialize the CLR
        # - these two tweaks are incompatible: either boost::thread must be link=shared,
        #   or the CLR object must be
        # HACK: not needed when using hacked tss_pe.cpp
        #<link>shared
        
        <toolset>msvc,<link>shared:<define>PWIZ_DYN_LINK
        <library>$(PWIZ_ROOT_PATH)/pwiz/utility/misc//pwiz_utility_misc
        <conditional>@vendor-api-requirements
        <conditional>@msvc-requirement
        <toolset>msvc:<using-clr>true # requires hacked msvc.jam
    : # default-build
    : # usage-requirements
        <library>$(PWIZ_ROOT_PATH)/pwiz/utility/misc//pwiz_utility_misc
        <conditional>@vendor-api-requirements
    ;


# a test utility, not a unit test
exe CompassDataTest
    : CompassDataTest.cpp
      pwiz_vendor_api_bruker
    ;

explicit CompassDataTest ;


install install_pwiz_vendor_api_bruker
    : $(API_PATH)/CompassXtractMS.dll
      $(API_PATH)/boost_regex-vc80-mt-1_33_1-BDAL_20070424.dll
      $(API_PATH)/boost_thread-vc80-mt-1_33_1-BDAL_20070424.dll
      $(API_PATH)/libfftw3-3.dll
      $(API_PATH)/libfftw3f-3.dll
      $(API_PATH)/NTB-vc80-mt-4_3_61.dll
      $(API_PATH)/Interop.EDAL.dll
      $(API_PATH)/Interop.EDAL.SxS.manifest
    ;

explicit install_pwiz_vendor_api_bruker ;

}
